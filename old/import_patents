#!/bin/bash

# Importer for CSV data from Lens.org
# Written by Darko Krizic (darko@krizic.net)
cs="cypher-shell $CYPHER_SHELL_PARAM"

CSVS="https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-broad-keywords-based-patents.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-patents-SARS-MERS.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-patents-SARS-MERS-TAC.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-limited-keywords-based-patents.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-CPC-based-patents.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-declared-patseq-organism.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-SARS-patents.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-MERS-patents.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-SARS-diagnosis-patents.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-MERS-diagnosis-patents.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-SARS-treatment.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Coronavirus-MERS-treatment.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Ventilators.csv https://lens-public.s3.us-west-2.amazonaws.com/coronavirus/patent/export/Respirators-and-surgical-masks.csv"
test ! -d csv && mkdir csv
cd csv
path=$(pwd)
for csv in $CSVS 
do
	file=$(basename $csv)
	echo "Downloading $csv to $file"
	wget -q $csv
    if [ ! -f $file ]
	then
		echo "ERROR: Downloaded file $file not found"
		break
	fi
    echo "Prepareing file $file for import"
	sed -e '1s/"\#"/ID/' -e '1s/[\(\) ]//g' $file >/home/covid/neo4j/neo4j_docker/import/patents.csv
	echo "Importing file patents.csv"
	cat ../merge.cypher | $cs
    echo "Removing import file"
    rm /home/covid/neo4j/neo4j_docker/import/patents.csv
    echo "Removing downloaded file $file"
    rm $file
done

echo "Running cleanups"
cat ../cleanup.cypher | $cs
cd ..
rm -rf csv
